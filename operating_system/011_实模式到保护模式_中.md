实模式到保护模式

■ 80286的光荣退场
    -历史意义

               ♦ 弓丨入了保护模式，为现代操作系统和应用程序奠定了基础
       -奇肥设计

              ♦ 段寄存器为24位，通用寄存器为16位（不伦務）

                   ，理论上，段寄存器中的数值可IU直接作为段基址
                   ,16位通用寄存器最多访问64K的内存
                   ，为了访问16M内存，必须不停切换段基址

实模式到保护模式

                                             ______ — —____________________________________________________________

■ 80386的登场（计算机新时期的标志）
    - 32位地址总线（可支持4G的内存空间）
    -段寄存器和通用寄存器都为32位
          •任何一个寄存器都能访问到内存的任意角落

                       ，开启了平坦内存模式的新时代

               z段基址为〇 ,使用通用寄存器访问4G内存空间

狄泰未来                 © 2018成都狄泰未来科技有限公司                                                                              唐佐林视^频教程

实模式到保护模式

■新时期的内存使用方式
    _实模式

               ♦ 兼容8086的内存使用方式（指哪打哪）

    -分段模式

               ♦ 通过[段地址：偏移地址]的方式将内存从功能上分段（數据段，代码段）

    -平坦模式

               ♦ 所有内存就是_个段[〇 : 32位偏移地址]

狄泰未来                 © 2018成都狄泰未来科技有限公司                                                                              唐佐林视^频教程

实模式到保护模式

■有趣的问题
                         x86指的究竟是什么处理器？

狄泰料未来                ◎ 2013成都狄泰未来科技有限公司                                                                              唐佐林孤频教程

实模式到保护模式                                                                                                                  、

■段属性定义

        mm             0x4000          保护模式下32位段
                       0x90            只雜雕段
        DA一32          0x92            可薛麵段
        DA DR          0x93            已访问可薛麵段
        DA.DRW         0x98            只执行代码段
        DA.DRWA        0x9A            可执行可读代码段
        DA_C           0x9C            只执行一致代码段
        DA.CR          0x9E            可执行可读一致代码段
        DA.CCO
        DA CCOR

狄泰料未来                ◎ 2〇13成都狄泰未来科技有限公司                                                                              唐佐林孤频教程

实模式到保护模式                                                                                                                                  a

■选择子属丨生定义

                              15-3               2 1-0
                          描述符索引值                 TI RPL

                          p SA_RPL0         equ  0

                     RPL A 一  SA RPL1       equ  1

                              SA一RPL2       equ  2

                          L SA RPL3         equ  3

                      rSA_TIG          equ       0 ; GDT
                     "Lsa_TIL
                                       equ       4 ; LDT

狄泰料未来                ◎ 2〇13成都狄泰未来科技有限公司                                                                              唐佐林孤频教程

实模式到保护模式

■保护模式中的段定义

%macro Descriptor B                                       ;段基址，段界限，段属性
       dw %2 & 0XFFFF
       dw %1 & 0xFFFF                                     ;段界限1
       db (%1 » 16) & 0xFF
       dw ((%2 » 8) & 0xF00)                              ;段基址1
       db (%1 » 24) & 0xFF                                ;段基址2

%endmacro                          (%3 & 0XF0FF);属性1 +段界限2 +属性2

                                                          ;段基址3
                                                          ;共8字节

31-24 23 22 21 20 19—16 15 14-13 12 11 — 8 7—0

段基址     G  D/B    L  AVL  段界限      P        DPL  S TYPE      段基址                                                     高32位
31 -24                    19 - 16                            23 - 16

           31-16                                 15-0

           段基址15 -- 0                            段界限15 -- 0                                                          低32位

---------------------------------我是可爱的页面分割线-------------------------------------
实模式到保护模式

■保护模式中的段定义

;GDT定义                       段基址， 段界限， 属性

}                               0,       0,            0

GDT一ENTR:YDescriptor            0,       SegCodeB2Len - 1, DA_C + DA—32

C0DE32_DES: Descriptor

y«
    ••••••

GdtLen               equ     $ - GDT—ENTRY ;GDT长度
GdtPtr:

                     dw      GdtLen - 1  ;GDT界限
                                         ;GDT基地址，需要重新计算
                     dd      0

狄泰未来                 ◎ 2018成都狄泰未来科技有限公司                   唐佐林视^频教

实模式到保护模式

■汇编小贴士
    - section关键字用于"逻辑的〃定义一段代码集合
    - section定义的代码段不同于[段地址：偏移地址]的代码段

• section定义的代码段仅限于源码中的代码段（代码节）

•[段地址：偏移地址]的代码段指内存中的代码段

      [SECTION .si]  db 0x1              0x01020000       0x03
             varl    db 0x3                      • S1
                     db 0x2                                •s2
      [SECTION .s2]
             var2                                               唐佐林视^频教程

      [SECTION .si]
             var3

狄泰未来                 ◎ 2018成都狄泰未来科技有限公司

实模式到保护模式

■汇编小贴士
     - [ b i t s 16]
         •用于指示编译器将代码按照16位方式进行编译
    - [bits 32]
         •用于指示编译器将代码按照32位方式进行编译

狄泰未来                 ◎ 2018成都狄泰未来科技有限公司                   唐佐林视^频教

实模式到保护模式

■注意事项

     -段描述表中的第0个描述符不使用（仅用于占位）
     -代码中必须显示的指明16位代码段和32位代码段

    - 必 须 使 用 jmp指令从16位代码段形啭到32位代码段

狄泰未来                 ◎ 2018成都狄泰未来科技有限公司                   唐佐林视^频教

The shortest answer is doing.

                          编程实验

                              保护模式
                            编程初体验

狄泰未来                 ◎ 2018成都狄泰未来科技有限公司                   唐佐林视^频教

实模式到保护模式

■问题

                为什么不直接使用标签定义描述符中的段基地址？
                为什么16位代码段到32位代码段必须无条件®齡？

狄泰未来                 ◎ 2018成都狄泰未来科技有限公司                   唐佐林视^频教程

实模式到保护模式

■需要掌握的重点
    - NASM将汇编文件当成一个独立的代码段编译
    一汇编代码中的标签（Label)代表的是段内偏移地址
    -实t莫式下需要配合段寄存器中的值计算标签的物理地址

---------------------------------我是可爱的页面分割线-------------------------------------
狄泰未来    ©2018成都狄泰未来科技有限公司             唐佐林视频教程

实模式到保护模式

■小知识
    -流水线技术
          •处理器为了提高效率将当前指令和后缴旨令预取到流水线
          •因此，可能同时预取的指令中既有16位代码又有32位代码
          •为了避免将32位代码用16位的方式运行，需要刷新流水线
         • 无 条 件 S赂专jmp能强制刷新流水线

狄泰未来    ©2018成都狄泰未来科技有限公司             唐佐林视频教程

 小结

■ 80386处理器是计算机发展史上的里程碑
■ 32位的寄存器和地址总线能够直接访问4G内存的任意角落
■需要在16位实模式中对GDT中的数据进行初始化
■ 代 码 中 需 要 为 GDT定义一个标识数据结构（GdtPtr)
■ 需 要 使 用 jmp指令从16位代码韵啭到32位代码

狄泰夺+未来  ◎ 2018成都狄泰未来科技有限公司            唐佐林视频教程

  狄泰未来

在这里收获的是未来，而不只是技术
              交流群：199546072

                  ◎ 2018成都狄泰未来科技有限公司

---------------------------------我是可爱的页面分割线-------------------------------------
