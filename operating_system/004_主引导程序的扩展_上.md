主引导程序的扩展

■限制

        主引导程序的代码量不能超过512字节！！

狄泰一+未来    © 2018成都狄泰未来科技有限公司                唐佐林视^频教程
                                             唐佐林视频教程
主引导程序的扩展

■突破限制的思路
     -主引导程序
         1. 完成最基本的初始化工作
         2. 从存储介质中加载程序到内存中
         孓将控制权交由新加载的程序执行
         4..........

狄泰一+未来    ◎ 2018成都狄泰未来科技有限公司

主引导程序的扩展

■突破限制的思路

存储介质

内存

狄泰一+未来    © 2018成都狄泰未来科技有限公司                唐佐林视^频教程

主引导程序的扩展

■问题
                主引导程序如何加载存储介质中的其它程序？

狄泰一+未来    © 2018成都狄泰未来科技有限公司                唐佐林视^频教程

主引导程序的扩展

■文件系统
    -存储介质上组织文件数据的方法（数据组织的方式)

狄泰一+未来                FAT12文件格式             唐佐林视^频教程

          © 2018成都狄泰未来科技有限公司

主引导程序的扩展

■文件系统示例
    一FAT1 2 是 DOS时代的早期文件系统
    - FAT12结构非常简单，一直沿用于软盘
    - FAT12的基本组织单位
          ♦字节（Byte ) : 基 本 數 据 单 位
          ♦扇 区 （ Sector) : 破 盘 中 的 最 据 单 元
          •簇（Cluster) : _个或多个扇区

狄泰一+未来    © 2018成都狄泰未来科技有限公司                唐佐林视^频教程

主引导程序的扩展

■解决方案
    - 使 用 FAT12对软盘（data.img )进行格式化
    一编写可执行程序（Loader) , 并 将 其 拷 贝 到 软 盘 中
    -主引导程序（Boot)在文件系统中查找Loader
    -将Loader复制到内存中，并通啭到入口处执行

---------------------------------我是可爱的页面分割线-------------------------------------
                          ◎ 2018成都狄泰未来科技有限公司                   唐佐林视频教程

狄奉令今未来

主引导程序的扩展

■实验：往虚拟软盘中写入文件
    一原材料：FreeDos , Bochs , bximage
    -步骤：

          •创建虚拟软盘data.img
           •在FreeDos中进行格式化（FAT12 )
           •将data.img挂载到Linux中，并写收入文件

                             © 20*18成都狄泰未来科技有限公司               唐佐林视频教程

狄泰未来

The shortest answer is doing.

                                编程实验

                              将文件写入虚拟软盘

                              © 2018成都狄泰未来科技有限公司               唐佐術嬲教程

狄泰令+未来

主引导程序的扩展

_ 下一步的工作

                    Boot查找目标文件（Loader),并读取
                                   文件的内容！

                              © 2018成都狄泰未来科技有限公司               唐佐林獅教程

狄泰一+未来

主引导程序的扩展

■ 深 入 FAT1 2 文 件 系 统

                   FAT12文件系统由弓丨导区，FAT表，根目

                               录项表和文件数据区组成。

                  ^区 隨 | 长 度 ____________ \ m

                          0            1 (512 B)   引导程序

                          1            9 (4608 B)  FAT 表 1

                          10           9 (4608 B)  FAT 表 2

                          19           14(9728 B)  @录文件项

                          33           一           文繊居

                              © 2018成都狄泰未来科技有限公司               唐佐林娜教程

狄泰夺+未来

主引导程序的扩展

■ FAT12的主弓丨导区

         主引导区存储的比较重要的信息是文件系统的类型，文件系
         统逻辑扇区总数，每簇包含的扇区数，等。主引导区最后以

         0X55AA两个字节作为结束，共占用一个扇区。

                              © 2018成都狄泰未来科技有限公司               唐佐林视频教程

狄泰未来

        主引导程序的扩展

标识                偏移t         类型       大小           默认值        i说明
BSJmpBoot           0          db        3                     如转指令
BS.OEMName          3          db        8        MSWIN4.1      OEM字符串，必须为8个字符，不足以交格填空
BPB_BytsPerSec      11         dw        2           0x200
BPB_SecPerClus      13                   1               •1i    每扇区字节数
BPB_RsvdSecCnt      14          db       2               A1     每簇占用的扇区数
BPB_NumFATs         16                   1               2      Boot占用的扇区数
BPB_RootEntCnt      17         dw         2          OxEO       FAT表的记录数
 BPB_TotSecl6       19          db        2          0xB40      最大根目录文件数
 BPB一Media          21          dw        1          OxFO       逻辑扇区总数
 BPB_FATSzl6         22         dw        2               9      媒体描述符
 BPB_SecPerTrk       24         db        2            0x12      每个FAT占用扇区数
 BPB_NumHeads        26         dw        2               2      每个磁道扇区数
 BPB_HiddSec         28         dw        4               0      磁头数
                     32         dw        4               0      隐藏扇区数
 BPB_TotSec32        36          dd        1              0      如果BPB_TotSecl6是0,则在这里记录扇区总数
 BS_DrvNum           37          dd        1              0
  BS_Reservedl                             1            0x29     中断13^驱动器号
  BS_BootSig          B8          db       4               0     未使用
  BS.VollD                                11                     扩展引导标志
  BS.VolLab           39         db        8          FAT12       卷序列号
  BS.FileSysType      43         db       448            0x00     卷标，必须是11个字符，不足以空格填充
  BOOT_Code           54         dd        2                      文件系统类型，必须是8个字符，不足填充空格
  END                 62                            0x55,0W
                     510          db                             i引导代码，由偏移0字节处的短跳转而来

                                 db                              j系统引导标识
                                  db

                                   db

        主引导程序的扩展

        ■ 实 验 ： 读 取 data.img中的文件系统信息
            -步骤：

                  •创建Fatl2Header结构体类型

                    •使用文件流读取前512字节的内容
                    •解析并打印相关的倍息

---------------------------------我是可爱的页面分割线-------------------------------------
狄泰未来  ©2018成都狄泰未来科技有限公司                唐佐林视频教程

The shortest answer is doing.

         编程实验

      读取FAT12文件系统信息

狄泰未来  ©2018成都狄泰未来科技有限公司                唐佐林视频教程

主引导程序的扩展

■实验结论

     L FreeDos中的format程序在格式化软盘的时候自动在第0扇区

           生成了一个主引导程序，这个主引导程序只打印一个字符串
     2.文件格式和文件系统都是用于定义数据如何存放的规则，只要遵

           循这个规则就能够成功读写目标麵

狄泰未来  ©2018成都狄泰未来科技有限公司                唐佐林视频教程

 小结

■主引导程序的代码量不能超过512字节
■可以通过主引导程序加载新程序的方式突破限制
■加载新程序需要依赖于文件系统
■ FAT12是一种早期用于软盘的简单文件系统
■ FAT12文件系统的重要信息存储于0扇区

      ◎ 2018成都狄泰未来科技有限公司               唐佐林视频教程

  狄泰未来

在这里收获的是未来，而不只是技术
              交流群：199546072

                   ◎ 2018成都狄泰未来科技有限公司

---------------------------------我是可爱的页面分割线-------------------------------------
