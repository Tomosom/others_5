保护模式中的特权级

■问题

        如何在不同特权级的代码段之间辦专执行？

狄泰一+未来                   © 2018,成都狄泰未来科技有限公司                                           唐佐林视^频教程

保护模式中的特权级

■—种新的描述符：门描述符（Gate Descriptor)
    -通过门描述符在不同特权级的代码间进行勘啭
    -根据应用场景的不同，门描述符分为：
          ♦调用门（Call Gates )
          ♦中断门（Interrupt Gate )
          ♦陷阱门（Trap Gate )
          ♦任务门（Task Gate )

狄泰一+未来                   © 2018,成都狄泰未来科技有限公司                                           唐佐林视^频教程

保护模式中的特权级

■门描述符的内存结构
    -每一个门描述符占用8字节内存

-不同类型门描述的内存含义不同

        31 — 16                               15 1413 12 11 — 87 6 5 4 3 2 1 0

                                              P DPL $ TYPE 0 0 0                             高32位

        31-16                                           15-0

                                                                                             低32位

狄泰一+未来                   © 2018,成都狄泰未来科技有限公司                                           唐佐林视^频教程

保护模式中的特权级

■调用门描述符（Call Gates ) 的 疋 义

        31 — 16                               15 1413 12 11 — 87 6 5 4 3 2 1 0

        偏移地址2                                 P DPL S                           Param        高32位
                                                        TYPE 0 0 0 Count

        31 — 16                                         15—0

        选赃                                              偏移地址1                                低32位

        %macro Gate 4

        dw (%2 & 0XFFFF)                                          ;偏移地址 1

        dw %1                                                     ;选择子

        dw (%3 & 0xlF) | ((%4 << 8) & 0XFF00) ; 属 性

        dw ((%2 » 16) & 0XFFFF)                                   ;偏移地址2

        %endmacro

保护模式中的特权级

■调用门描述符的工作原理

狄泰一+未来                   © 2018,成都狄泰未来科技有限公司                                           唐佐林视^频教程

保护模式中的特权级

■调用门描述符的使用

; G O T definition                   段基址,               段界限，          段脣丨生

>                        Descriptor                           0,      0
                                                                      DA—_C + DA_32
GDT_ENTRY                Descriptor  0,       Code32SegLen - 1 ,      DA_.DRWA + DA_32
CODE32_DESC                                                           DA._DRW + DA_32
VIDEO_DESC               Descriptor 0XB8000,          0X07FFF,        DA._C + DA_32
STACK32_DESC
FUNCTION_DESC            Descriptor  0>       TopOfStack32>
; G a t e Descriptor     Descriptor
；Call Gate                           0, FunctionSegLen - 1 ,
FUNC_CG_Add_DESC
FUNCMCG_Sub_DESC                     选择子，               偏移，参数个数，属性
;GDT end
                      :  Gate        FunctionSelector,  CG_Add>   0,    DA_386CGate

                      :  Gate        FunctionSelector,  CG_Sub>   0,    DA_386CGate

狄泰一+未来                   © 2018,成都狄泰未来科技有限公司                                           唐佐林视^频教程

保护模式中的特权级

■调用门描述符的使用

; G D T Selector         equ (0x0001 << 3) + SA_TIG + SA_RPL0
Code32Selector
VideoSelector            equ (0x0002 << 3) + SA_TIG + SA_RPL0
Stack32Selector
FunctionSelector         equ (0x0003 << 3) + SA^TIG + SA_RPL0
FuncCGAddSelector
FuncCGSubSelector        equ (0x0004 << 3) + SA_TIG + SA„RPL0

                         equ (0x0005 << 3) + SA_TIG + SA_RPL0 ; point to Add function

                         equ (0x0006 << 3) +  SA_TIG + SA_RPL0 ;      point to Sub function

        call FuncCGAddSelector : 0 ; call Add function
        call FuncCGSubSelector : 0 ; call Sub function

---------------------------------我是可爱的页面分割线-------------------------------------
狄泰一+未来                                                                                                   ◎ 2018成都狄泰未来科技有限公司        唐佐林娜教程

保护模式中的特权级

■汇编小贴士
  一汇编语言中的®!^专方式
           ♦段内跳转：call, jmp
               ，参数为相对地址，函數调用时只需要保存当前偏移地址
          ♦段间®择专：call fan jmp far
               ，参數为趙 5 子和偏移地址
               z函數调用时需要同时保存段基地址和彳藤刻6址

狄泰一+未来                                                                                                   ◎ 2018成都狄泰未来科技有限公司

The shortest answer is doing

                                                                                                         编程实验

                                                                                                           初探调用门

狄泰一+未来                                                                                                   ◎ 2018,成都狄泰未来科技有限公司       唐佐林视^频教程

保护模式中的特权级

■实验结论
    - 门 描 述 符 I种f菊朱的描述符，需要注册于段描述符表
    -调用门可以看作一个函数指针（保存具体函数的入口地址）
    -通过调用门选择子对相应的函数进行远调用（callfar)
    -可以直接使用选择子：偏移地址的方式调用其它段的函数
    -使用调用门时偏移地址无意义，仅仅是语法需要（为什么？）

                                                                                                      —  —                         唐佐林视^页教程

狄泰未来                                                                                                           ◎ 2018成都狄泰未来科技有限公司

保护模式中的特权级

■历史遗留问题
                   保护模式下的不同段之间如何进行代码
                       复用€如：调用同一个函数）？

狄泰一+未来                                                                                                   ◎ 2018,成都狄泰未来科技有限公司       唐佐林视^频教程

保护模式中的特权级

■解决方案
    -将不同代码段需要复用的函数定义到独立的段中（retf)
    -计算每一个可复用函数的偏移量（FuncName - $$ )
     一通过段选择子：偏移地址的方式对目标函数进行远调用

狄泰一+未来                                                                                                   ◎ 2018,成都狄泰未来科技有限公司       唐佐林视^频教程

The shortest answer is doing.

                                                                                                         编程实验

                                                                                                         解决历史遗留问题

狄泰一+未来                                                                                                   ◎ 2018,成都狄泰未来科技有限公司       唐佐林视^频教程

 小结

■门描述符是一种特殊的描述符，需要注册于段描述符表
■门描述符分为：调用门，中断门，陷阱门，任务门
■调用门可以看作一个函数指针（保存具体函数的入口地址）
■调用门选择子对应的函数调用方式为远调用（call far)

---------------------------------我是可爱的页面分割线-------------------------------------
狄泰夺+未来  ◎ 2018成都狄泰未来科技有限公司

To be continued ...

■问题

        使用调用门如何实现不同特权级代码之间
        白■啭（如：从高特权级到低特权级）？

      狄泰未来

     在这里收获的是未来，而不只是技术!
               交流群：199546072

                 ◎ 2018成都狄泰未来科技有限公司

---------------------------------我是可爱的页面分割线-------------------------------------
