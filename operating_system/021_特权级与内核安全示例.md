恃权级与内核安全示例

- 问题
            既然通常情况下选择子中的RPL与对应描述符中的
                     DPL相同，那么是否可以取缔RPL ?

狄泰夺+未来  ◎201S成都狄泰未来科技有限公司                        唐佐林视频教程

特权级与内核安全示例

- 答案
        RPL是保证内核数据安全的关键要素之_，♦ 在内核代码

                    中有决定'注彳乍用，绝对不能取缔！

狄泰夺+未来  ©2013成都狄泰未来科技有限公司                        唐佐林视频教程

特权级与内核安全示例

-  一 个生活中的例子。。^

                  如果是你，你会用什么方法拿到核心代码？

        DPL = 3                        DPL = 0
                    ◎sois成都狄泰未来科技有限公司
狄泰夺+未来                                           唐佐林视频教程

特权级与内核安全示例

- 解决方案
    -和老员工（DPL = 0 )搞好关系@

     -请老员工帮丨亡拷贝核心代码（提升特权级访问代码）©

特权级与内核安全示例

- 计算机中的相似情形

           用户程序想要访问获取操作系统内核中的私密数据!

        用户程序只要探测到内核函数所对应    DPL = 0            DPL = 0
        的选择子和偏移量，即可通过调用门               _N
        进行调用，进而获取内核私密數据。  内核代码段
                                         >内徽据段

                                       V

                          调用门                     DPL = 0

                                                 内核函数

The shortest answer is doing.

                    编程实验

                              内核私密数据的获取
                                      loader-21

狄泰—+未来  ◎ 2018成都狄泰未来科技有限公司                       唐佐林彳见频教程

特权级与内核安全示例

- 初步解决方菜：
    -获取段寄存器中RPL的值
    -判断RPL的值是否为SA_RPL0
          • true-检查通过，可继续访问数据
          • false-特权级较低，触发异常

---------------------------------我是可爱的页面分割线-------------------------------------
狄泰一+未来          ◎ 2018成都狄泰未来科技有限公司                           唐佐林视频教程

特权级与内核安全示例

- 代码流程

狄泰一+未来          ◎ 2018成都狄泰未来科技有限公司

特权级与内核安全示例

- 小技巧-通过下标为0的描述符触发异常

        mov ax, 0              //使用〇选择子
        mov fs, ax             //将段寄存器指向〇位置处
        mov byte [fs: 0 ] , 0
                                / / 往 CM2- 处写入數据〇〇PS

                               类似于

                int* fs = 0;
                *fs = 0；

狄泰未来            © 2018成都狄泰未来科技有限公司                           唐佐林祁I频教程

The shortest answer is doing.

                 编程实验

                内核私密数据的获取
                    初步解决方案

狄泰—今未来          ◎ 2018成都狄泰未来科技有限公司                           唐佐林彳见频教程

特权级与内核安全示例

- 当前方案存在的问题

                     用户程序可以通过"伪造"选择子中的RPL值,
                    从而绕开安全检查的机制（CheckRPL )。

狄泰—今未来          ◎ 2018成都狄泰未来科技有限公司                           唐佐林彳见频教程

特权级与内核安全示例

- 解决思路：追踪真实的请求者
    1♦ 在栈中获取函数远调用前CS寄存器的值（请求者）
    2 . 从 之 前 CS寄存器的值中获取RPLa (请求者特权级）
    孓用RPLnI新到数据缓冲区对应的段寄存器中
    4 . 使 用 CheckRPL对段寄存器进行安全检查

狄泰—今未来          ◎ 2018成都狄泰未来科技有限公司                           唐佐林彳见频教程

特权级与内核安全示例

- 追踪真实的请求者

                               ; e s - - > d a t a selector

             高

                               mov cx, [esp + 4]             ;犾取真买请永者
                               and CX, 0x0003                ;犾取文!求者特权级

        CS                     mov aXj es
                               and ax. 0XFFFC
esp 乂   eip                    or ; a x , ( : x              ;清零RPL部分
                                                             ; 加上请求者特权级

             低                 mov es, ax

狄泰未来            © 2018成都狄泰未来科技有限公司                           唐佐林祁I频教程

The shortest answer is doing.

                 编程实验

                内核私密数据的获取
                    最终解决方茶

---------------------------------我是可爱的页面分割线-------------------------------------
狄泰夺+未来  ◎ 2018成都狄泰未来科技有限公司      唐佐林视频教程

 小结

-  RPL是保证内核数据安全的关键要素之一
- 内核代码可通过追踪真实请求者特权级判断操作合法性
- 但凡进行函数远调用，真实请求者的选择子就会存储于栈中
- 通过提取真实特权级（RPL )能够保证内核数据安全

狄泰未来    ©2018成都狄泰未来科技有限公司       唐佐林视频教程

 狄泰未来

在这里收获的是未来，而不只是技术!
         交流群：199546072

            ◎ 2018成都狄泰未来科技有限公司

---------------------------------我是可爱的页面分割线-------------------------------------
