# 深入特权级转移

- 初识任务状态段 (Task State Segment)
    - 处理器所提供的硬件数据结构，用于实现多任务解决方案
    - TSS 中保存了关键寄存器的值以及不同特权级使用的栈

- TSS 中不同特权级的栈信息
    - 在 TSS 中只保存了 3 个栈的信息
        - 特权级0 : ss0, esp0
        - 特权级1 : ss1, esp1
        - 特权级2 : ss2, esp2

    ![](_v_images_/.png)

- 特权级转移时的栈变化
    - 低特权级 → 高特权级（调用门）
        - 从 TSS 获取高特权级目标段
        - 将低特权级栈信息压入高特权级栈中（ss 和 esp)
    - 高特权级 → 低特权级（retf)
        - 将低特权级枝信息从高特权级枝中取出并恢复到SS和esp

- 有趣的问题
    TSS中为什么只保存3个特权级 (0, 1, 2 )的栈信息 ？

- 目标实验（操作系统雏形）
    - 低特权级 ← → 高特权级
        1. 定义 32 位核心代码段和数据段（Privilege = 0 )
        2. 定义 32 位任务代码段和数据段（Privilege = 3 )
        3. 由核心代码段跳转到任务代码段执行（高 → 低）
        4. 在任务代码段中调用高特权级代码段打印字符串（Call Gate )

- 目标实验（操作系统雏形）
    ![](_v_images_/.png)

- 注意事项
    - 特权级转移时会发生栈的变换（如何变换？）
    - 栈的变化需要在TSS结构体中预先定义
    - TSS结构体作为一个独立段定义（描述符，选择子）
    - 在核心代码段中加载具体的TSS结构体（ltr TSSSelector)

# 编程实验 特权级转移综合实验

- 问题
    RPL 究竟是什么？有什么用？

- RPL的意义
    - 位置意义
        - 选择子或段寄存器的最低2位
    - 请求意义
        - 资源请求的特权级（不同于当前特权级CPL )

        ![](_v_images_/.png)

- RPL的意义
    当需要请求获取某种资源时，处理器通过 CPL, RPL 和 DPL 共同确定请求是否合法！
    ![](_v_images_/.png)

- To be continued ...
    处理器通过什么规则判断资源请求或代码跳转是否合法？

# 小结
- TSS 是通过调用门转移到高特权级执行的关键
- TSS 是处理器的硬件数据结构，用于实现多任务
- TSS 结构体遵循保护模式下内存使用的规则
- RPL 在请求资源时是合法性判断的依据之一
- 处理器使用 CPL, RPL 和 DPL 共同确定合法性
