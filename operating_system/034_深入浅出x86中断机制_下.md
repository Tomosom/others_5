# 深入浅出 x86 中断机制
- 问题
    中断与对应的服务程序间如何建立关联?
    在代码层面如何进行转移

- 实模式下的中断处理
    - 使用中断向量表映射不同中断与中断服务程序
    - 中断向量表 (Interrupt Vector Table)
        - 起始于物理地址0, 长度为 1 KB
        - 每个单元4字节, 连续256个单元
        - 每个单元存放一个中断服务程序的入口地址

- 中断向量表 (IVT)
    - 处理器接收到中断信号时, 能够询问到中断向量 (中断类型号); 进而, 通过中断向量查找 IVT, 获取ISR 入口地址; 之后, 跳转执行 (类型函数调用).

    ![](_v_images_/.png)

- 中断响应与处理
    ![](_v_images_/.png)

- 思考
    实模式下的中断向量表 (IVT) 和中断服务程序 (ISR) 需要操作系统内核来建立吗?

- 你不知道的故事
    - x86 系类处理器上电后直接进入实模式
    - 硬件设计将 ROM 中的 BIOS 拷贝到内存中
    - BIOS 代码的入口地址为 0xFFFF0
    - 硬件设计将 cs 设置为0xFFFF, ip 设置为0x0000

- BIOS 从 0xFFFF0 处开始执行
    - 检测计算机系统的硬件, 并做一系列简单的初始化
    - 在内存中建立中断向量表 (IVT) 和中断服务程序 (ISR)

    ![](_v_images_/.png)

# 编程实验 再论计算机的启动流程

- 保护模式下的中断处理
    - 使用中断描述符表映射不同中断与中断服务程序
    - 中断描述符表（InterruptDescriptorTable)
        - 可以包含中断门，陷阱门，任务门
        - 门描述符
            - 包含中断服务程序的入口（选择子：偏移）
            - 包含各种用于合法性检查的属性（如：特权级）

-  中 断 门 描 述 符 （Interrupt Gate) 的 定 义
    ![](_v_images_/.png)
    Note:
    调用门，中断门，陷阱门的字段布局完全相同；当Type表示
    中断门（1110)和陷阱门（1111)时，Param字段未使用。

-  中 断 描 述 符 表 （ IDT)
    - 中断描述表是中断描述符的线性集合（类似GDT)
    - 每个元素的大小为8字节（即••中断描述符）
    - 使用前将起始地址及界限载入丨DTR中（专用指定：lidt)

    [section .idt]          目齡， 参                    缴懷属性
      align 32             SelectorCode32, ISR_Entry,      0, DA_386IGate
      [bits 32]
      LABEL IDT:

      ;门
      %rep 255

                     Gate
      %endnep

      IdtLen               equ $ - LABEL_IDT
      IdtPtr               dw IdtLen - 1 ;段 界 限
                           dd 0 ;基 地 址


- 保护模式下的中断处理
    - 每个中断产生一个中断向量（中断类型号）
    - 通过中断向量在IDT中查找对应的中断描述符
    - 通过中断描述符中的选择子和偏移可找到ISR的入口地址

- 保护模式下的中断处理
    ![](_v_images_/.png)

深入浅出x86中断机制

- 注意事项
    - IDT除了提供ISR入口地址，还提供了特权级等属性
    - 中断发生后，转移执行ISR代码前需要进行特权级检查
    - 实模式与保护模式的中断向量完全一致（硬件不变）
    - IDT中必须提供每种中断所对应的ISR入口地址

# 编程实验 保护模式下的中断方式

-  To be continued ...
    思考：
    不同外设如何向处理器发送中断信号？
    当多个外设同时产生中断时，如何进行处理?
