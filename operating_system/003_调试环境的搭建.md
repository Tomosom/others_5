# 调试环境的搭建

- 问题
    如何调试主引导区的代码？

- Bochs (另一款优秀的虚拟机软件）
    - 专业模拟 X86 架构的虚拟机
    - 开源且高度可移植，由C++编写完成
    - 支持操作系统开发过程中的断点调试
    - 通过简单配置就能够运行绝大数主流的操作系统

- 支持调试功能的 Bochs 版本
    1. 下载源码：https://sourceforge.net/projects/bochs/files/
    2. 解压缩 bochs-2.x.x.tar.gz -> bochs-2.x.x
    3. 进入源码目录：cd bochs-2.x.x
    4. ./configure --enable-debugger --enable-disasm
    5. make
    6. sudo make install

# 编程实验 Bochs的安装与配置

- 小贴士
    - 确定bochs的安装路径（which bochs )
    - 安装 vgabios ( apt-get install vgabios )
    - 确定 vgabios 的安装路径（whereis vgabios )


- Bochs 的启动文件

```perl
#how much memory the emulated machine will have
megs:32

# filename of ROM images
romimage:file=/usr/local/share/boch$/BIOS-boch$-late$t
vgaromimage:file=/usr/share/vgabio$/vgabio$.bin

#what disk images will be used
floppya:1_44=a.img. $tatu$=in$erted

# choose the boot disk.
boot:floppy

#where do we send log messages?
#log: bochsout.txt

# disable the mouse
mouse:enabled=0

# enable key mapping, using US layout as default.
keyboard_mapping:enabled=1, map=/usr/local/share/bochs/keymaps/x11-pc-us.map
```

- 启动 bochs 虚拟机
    - 显示方式 ：bochs -f bochsrc_file
    - 隐式方式 ：bochs
        - 当前目录下的启动文件名
            - .bochsrc
            - bochsrc
            - bochsrc.txt

- 调试环境验证
    ![](_v_images_/.png)

# 编程实验 Bochs的验证

- Bochs中的常用调试命令

|        命令         |        功能        |     示例     |
| ------------------- | ------------------ | ------------ |
| b (break)           | 设置断点            | b 0x7c00     |
| c (continue)        | 继续执行            | c            |
| s (step)            | 单步执行            | s            |
| info b (info break) | 查看当前所有断点     | info b       |
| info cpu            | 查看当前CPU状态     | info epu     |
| r (reg)             | 查看常规寄存器状态   | r            |
| sreg                | 查看段寄存器状态     | sreg         |
| x/Nuf expression    | 查看内存中的数据     | x/2bx 0x7c00 |
| trace on[off]       | 开关：打印执行的指令 | trace on     |
| trace-reg on[off]   | 开关:打印寄存器的值  | trace-reg on |

# 小结
- Bochs 是一款专业模拟 x86 架构的虚拟机
- 从源码安装 Bochs 可以获得调试功能的支持
- Bochs 的启动配置文件是正确运行关键
- Bochs 支持断点调试，其调试命令与GDB类似
