# 突破 512 字节的限制

- 突破限制的预备工作(两个功能函数)
![](_v_images_006/1.png)

# 创建字符串打印函数
- 问题
    主引导程序中<font color=red>如何进行字符串打印</font>？
    > 前面的程序, 是利用了字符的打印来实现字符串打印, 并没有一次性打印一个字符串, 是通过循环的方式将字符串中的数据逐个打印出来实现的
    > 要实现一次性打印,需利用BIOS中的中断

- BIOS中的字符串打印
    - 指定打印参数 ( <font color=red>AX = 0x1301, BX = 0x0007</font> )
        > 规定
    - 指定字符串的内存地址 ( <font color=#d0d>ES:BP = 串地址</font> )
        > 按段地址以及段内偏移地址的方式来指定目标字符串的内存地址
        > 前面讲过: 在汇编语言中, 使用过段地址加上段内偏移地址的方式来确定最终的内存地址的
    - 指定字符串的长度 ( <font color=#d00>CX = 串长度</font> )
    - 中断调用 ( <font color=blue>int 0x10</font> )

- 字符串打印示例

    ```x86asm
    ; 指定字符串地址
    mov ax, msg    ; 字符串在内存中的位置, msg:代表字符串在内存中某个段内的偏移地址
    mov bp, ax     ; 再赋给 bp
    mov ax, ds     ; 指定段地址. 为什么不直接 mov es, ds ???
    mov es, ax     ; 在这个示例中,我们的目标字符串在 es 段中

    ; 指定字符串长度
    mov cx, 6

    ; 指定打印参数
    mov ax, 0x1301
    mov bx, 0x0007

    int 0x10
    ```

- 汇编小贴士
    - 汇编中可以定义函数（函数名使用<font color=blue>标签</font>定义）
        - `call function` (调用函数, function : 函数的入口地址)
        - 函数体的最后—条指令为 <font color=blue>ret</font> (返回指令)
    - 如果代码中定义了函数，那么需要定义栈空间
        - <font color=#d0d>用于保存关键寄存器的值</font>
        - 栈顶地址通过 <font color=red>sp</font> 寄存器保存
    - 汇编中的 "常量定义" (<font color=blue>equ</font>)
        - 用法：`Const equ 0x7c00    ;#define Const 0x7c00`
        - 与 <font color=red>dx</font> (<font color=blue>db, dw, dd</font>)的区别：
            - <font color=red>dx</font> 定义占用相应的内存空间
            - <font color=blue>equ</font> 定义<font color=red>不会占用</font>任何内存空间
            > 可理解为 C语言中定义变量与定义宏之间的差异

# [<u>编程实验 定义打印函数 print</u>](code/006_突破512字节的限制_上)
1. 创建makefile简化工作



# 软盘读取
- 问题
    主引导程序中<font color=red>如何读取指定扇区处的数据</font>？

- 软盘的构造
    - 一个软盘有2个盘面，每个盘面对应1个磁头
    - 每一个盘面被划分为若干个圆圏，成为柱面（磁道）
    - 每一个柱面被划分为若干个扇区，每个扇区512字节

    ![](_v_images_006/2.png)

- 3.5寸软盘的数据特性
    - 每个盘面一共80个拄面 (编号为0 - 79)
    - 每个拄面有18个扇区 (编号为1 - 18)
    - 存储大小：
        2 * 80 * 18 * 512 = 1474560 Bytes = 1440 KB
        > 2个盘面, 80个柱面, 18个扇区, 512字节
- 软盘数据的读取
    - 软盘数据以扇区（<font color=red>512字节</font>）为单位进行读取
    - 指定数据所在位置的<font color=blue>磁头号，拄面号，扇区号</font>
    - 计算公式：
    ![](_v_images_006/3.png)
    > 如何指定我们感兴趣的扇区?

- BIOS中的软盘数据读取 (int 0x13)
    ![](_v_images_006/4.png)

- 软盘数据读取流程
    ![](_v_images_006/5.png)


- 汇编小贴士
    - 汇编中的<font color=red>16位</font>除法操作（div )
        - 被除数放到 AX 寄存器
        - 除数放到通用寄存器或内存单元（因为是16位除法, 所以除数必须是<font color=red>8位</font>）
        - 结果：商位于AL, 余数位于 AH

# [<u>编程实验 磁盘数据的读取</u>](code/006_突破512字节的限制_上)

# 小结
- 当汇编代码中定义了函数，那么也需要定义栈空间
- 读取数据前，<font color=#d0d>逻辑扇区号需要转化为磁盘的物理位置</font>
- 物理软盘上的数据位置由<font color=blue>磁头号，柱面号，扇区号</font>唯一确定
- 软盘数据以扇区（<font color=red>512字节</font>）为单位进行读取
